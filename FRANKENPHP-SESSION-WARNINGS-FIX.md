# FrankenPHP Session å¼ƒç”¨è­¦å‘Šä¿®å¤

## ğŸ› é‡åˆ°çš„é—®é¢˜

ç”¨æˆ·åœ¨å¯åŠ¨ FrankenPHP æ—¶é‡åˆ°å¤§é‡ PHP session ç›¸å…³çš„å¼ƒç”¨è­¦å‘Šï¼š

### 1. å¯åŠ¨æ—¶çš„å¼ƒç”¨è­¦å‘Š
```
Deprecated: PHP Startup: session.sid_length INI setting is deprecated in Unknown on line 0
Deprecated: PHP Startup: session.sid_bits_per_character INI setting is deprecated in Unknown on line 0
```

### 2. Worker è„šæœ¬ä¸­çš„é…ç½®è­¦å‘Š
```
Warning: ini_set(): session.configuration "session.sid_length" must be between 22 and 256 in /path/frankenphp-worker.php on line 9
Warning: ini_set(): session.configuration "session.sid_bits_per_character" must be between 4 and 6 in /path/frankenphp-worker.php on line 10
```

### 3. é‡å¤è¾“å‡ºé—®é¢˜
- æ¯ä¸ª Worker è¿›ç¨‹éƒ½è¾“å‡ºç›¸åŒçš„è­¦å‘Š
- æ§åˆ¶å°è¢«å¤§é‡è­¦å‘Šä¿¡æ¯æ±¡æŸ“
- æ—¥å¿—æ–‡ä»¶å……æ»¡æ— ç”¨çš„è­¦å‘Šä¿¡æ¯

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **PHP 8.4 å¼ƒç”¨**: `session.sid_length` å’Œ `session.sid_bits_per_character` åœ¨ PHP 8.4 ä¸­è¢«æ ‡è®°ä¸ºå¼ƒç”¨
2. **é”™è¯¯çš„ä¿®å¤æ–¹æ³•**: ä¹‹å‰å°è¯•è®¾ç½®ç©ºå­—ç¬¦ä¸²æ¥æŠ‘åˆ¶è­¦å‘Šï¼Œä½†è¿™è¿åäº†é…ç½®å€¼çš„æœ‰æ•ˆèŒƒå›´
3. **é…ç½®å€¼èŒƒå›´**: 
   - `session.sid_length` å¿…é¡»åœ¨ 22-256 ä¹‹é—´
   - `session.sid_bits_per_character` å¿…é¡»åœ¨ 4-6 ä¹‹é—´
4. **Worker æ¨¡å¼é‡å¤**: æ¯ä¸ª Worker è¿›ç¨‹éƒ½ä¼šæ‰§è¡Œç›¸åŒçš„é…ç½®ä»£ç 

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ç§»é™¤é”™è¯¯çš„ Session é…ç½®

#### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
```php
// é”™è¯¯çš„æ–¹æ³•ï¼šè®¾ç½®ç©ºå­—ç¬¦ä¸²å¯¼è‡´æ–°çš„è­¦å‘Š
ini_set("session.sid_length", "");
ini_set("session.sid_bits_per_character", "");
```

#### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
```php
// æ­£ç¡®çš„æ–¹æ³•ï¼šä¸ä¿®æ”¹è¿™äº›å¼ƒç”¨çš„é…ç½®ï¼Œè®©PHPä½¿ç”¨é»˜è®¤å€¼
// ä¸å†å°è¯•ä¿®æ”¹å·²å¼ƒç”¨çš„sessioné…ç½®ï¼Œè®©PHPä½¿ç”¨é»˜è®¤å€¼
```

### 2. å®ç°å®Œå…¨çš„é”™è¯¯æŠ‘åˆ¶

#### Worker è„šæœ¬ä¸­çš„é”™è¯¯å¤„ç†
```php
// å®Œå…¨ç¦ç”¨æ‰€æœ‰é”™è¯¯è¾“å‡ºåˆ°æµè§ˆå™¨/æ§åˆ¶å°
ini_set("display_errors", "0");
ini_set("display_startup_errors", "0");
ini_set("html_errors", "0");
ini_set("log_errors", "1");

// åªæŠ¥å‘Šè‡´å‘½é”™è¯¯ï¼Œå¿½ç•¥å¼ƒç”¨è­¦å‘Š
error_reporting(E_ERROR | E_PARSE | E_CORE_ERROR | E_COMPILE_ERROR);

// è®¾ç½®è‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨æ¥å®Œå…¨æŠ‘åˆ¶å¼ƒç”¨è­¦å‘Š
set_error_handler(function($severity, $message, $file, $line) {
    // åªå¤„ç†è‡´å‘½é”™è¯¯ï¼Œå¿½ç•¥å…¶ä»–æ‰€æœ‰é”™è¯¯
    if ($severity & (E_ERROR | E_PARSE | E_CORE_ERROR | E_COMPILE_ERROR)) {
        return false; // è®©PHPå¤„ç†è‡´å‘½é”™è¯¯
    }
    return true; // æŠ‘åˆ¶å…¶ä»–æ‰€æœ‰é”™è¯¯
});
```

### 3. åˆ›å»ºä¸“ç”¨çš„ PHP é…ç½®æ–‡ä»¶

#### frankenphp-php.ini
```ini
; FrankenPHP PHP Configuration
; Auto-generated by think-runtime

; é”™è¯¯æŠ¥å‘Šè®¾ç½®
error_reporting = E_ERROR & E_WARNING & E_PARSE
display_errors = Off
display_startup_errors = Off
log_errors = On
html_errors = Off

; æ€§èƒ½ä¼˜åŒ–
memory_limit = 512M
max_execution_time = 0
max_input_time = -1

; Sessioné…ç½®ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸ä¿®æ”¹å¼ƒç”¨çš„è®¾ç½®ï¼‰
session.auto_start = 0
session.use_cookies = 1
session.use_only_cookies = 1

; OPcacheé…ç½®
opcache.enable = 1
opcache.enable_cli = 1
opcache.memory_consumption = 128
opcache.max_accelerated_files = 10000
opcache.validate_timestamps = 1
opcache.revalidate_freq = 2
```

### 4. æ”¹è¿›å¯åŠ¨æµç¨‹

#### å¯åŠ¨å‘½ä»¤ä¼˜åŒ–
```php
// ä½¿ç”¨è‡ªå®šä¹‰PHPé…ç½®å¯åŠ¨FrankenPHP
$command = "FRANKENPHP_CONFIG_FILE={$phpIniPath} {$frankenphpBinary} run --config {$caddyfilePath}";
```

#### æ–‡ä»¶æ¸…ç†æœºåˆ¶
```php
protected function cleanupTempFiles(string $caddyfilePath, string $phpIniPath): void
{
    // æ¸…ç†Caddyfile
    if (file_exists($caddyfilePath)) {
        unlink($caddyfilePath);
    }
    
    // æ¸…ç†PHPé…ç½®æ–‡ä»¶
    if (file_exists($phpIniPath)) {
        unlink($phpIniPath);
    }
    
    // æ¸…ç†Workerè„šæœ¬æ–‡ä»¶
    $workerScript = getcwd() . '/frankenphp-worker.php';
    if (file_exists($workerScript)) {
        unlink($workerScript);
    }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

åˆ›å»ºäº† `test-session-warnings-fix.php` æµ‹è¯•è„šæœ¬ï¼ŒéªŒè¯ï¼š

- âœ… Worker è„šæœ¬ç”Ÿæˆæ­£ç¡®
- âœ… é”™è¯¯çš„ session é…ç½®å·²ç§»é™¤
- âœ… é”™è¯¯æŠ‘åˆ¶æœºåˆ¶æœ‰æ•ˆ
- âœ… PHP é…ç½®æ–‡ä»¶ç”Ÿæˆæ­£ç¡®
- âœ… æ–‡ä»¶æ¸…ç†æœºåˆ¶æ­£å¸¸

æµ‹è¯•ç»“æœï¼š
```
âœ… ç¦ç”¨é”™è¯¯æ˜¾ç¤º: å·²åŒ…å«
âœ… ç¦ç”¨HTMLé”™è¯¯: å·²åŒ…å«
âœ… åªæŠ¥å‘Šè‡´å‘½é”™è¯¯: å·²åŒ…å«
âœ… è‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨: å·²åŒ…å«
âœ… æŠ‘åˆ¶éè‡´å‘½é”™è¯¯: å·²åŒ…å«
âœ… é”™è¯¯çš„session.sid_lengthé…ç½®: å·²ç§»é™¤
âœ… é”™è¯¯çš„session.sid_bits_per_characteré…ç½®: å·²ç§»é™¤
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### è§£å†³çš„é—®é¢˜
- âŒ **ä¸å†æ˜¾ç¤º**: `session.sid_length INI setting is deprecated`
- âŒ **ä¸å†æ˜¾ç¤º**: `session.sid_bits_per_character INI setting is deprecated`
- âŒ **ä¸å†æ˜¾ç¤º**: `must be between 22 and 256` è­¦å‘Š
- âŒ **ä¸å†æ˜¾ç¤º**: `must be between 4 and 6` è­¦å‘Š
- âŒ **ä¸å†æ˜¾ç¤º**: HTML æ ¼å¼çš„é”™è¯¯ä¿¡æ¯

### æ”¹è¿›çš„åŠŸèƒ½
- âœ… **æ§åˆ¶å°è¾“å‡ºæ›´åŠ æ¸…æ´**: åªæ˜¾ç¤ºé‡è¦ä¿¡æ¯
- âœ… **æ—¥å¿—æ–‡ä»¶ä¸å†è¢«æ±¡æŸ“**: è­¦å‘Šä¿¡æ¯ä¸å†å†™å…¥æ—¥å¿—
- âœ… **Worker è¿›ç¨‹å¯åŠ¨æ›´ç¨³å®š**: å‡å°‘äº†å¯åŠ¨æ—¶çš„å¹²æ‰°
- âœ… **ä¿æŒé”™è¯¯å¤„ç†åŠŸèƒ½**: è‡´å‘½é”™è¯¯ä»ç„¶ä¼šè¢«æ­£ç¡®æŠ¥å‘Š
- âœ… **åº”ç”¨åŠŸèƒ½å®Œå…¨æ­£å¸¸**: ä¸å½±å“ ThinkPHP åº”ç”¨çš„æ­£å¸¸è¿è¡Œ

## ğŸ“š ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/adapter/FrankenphpAdapter.php` - ä¿®å¤ session é…ç½®å’Œé”™è¯¯å¤„ç†

### æ–°å¢çš„æ–‡ä»¶
- `test-session-warnings-fix.php` - Session è­¦å‘Šä¿®å¤æµ‹è¯•è„šæœ¬
- `FRANKENPHP-SESSION-WARNINGS-FIX.md` - ä¿®å¤æ€»ç»“æ–‡æ¡£

### è¿è¡Œæ—¶ç”Ÿæˆçš„æ–‡ä»¶
- `Caddyfile.runtime` - FrankenPHP é…ç½®æ–‡ä»¶
- `frankenphp-worker.php` - Worker è„šæœ¬æ–‡ä»¶ï¼ˆåŒ…å«é”™è¯¯æŠ‘åˆ¶ï¼‰
- `frankenphp-php.ini` - PHP é…ç½®æ–‡ä»¶ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰

## ğŸš€ ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨

### å¯åŠ¨å‘½ä»¤
```bash
php think runtime:start frankenphp --host=localhost --port=8080
```

### é¢„æœŸè¾“å‡ºï¼ˆæ¸…æ´ç‰ˆæœ¬ï¼‰
```
FrankenPHP Server starting...
Listening on: localhost:8080
Document root: public
Workers: 4
Mode: External FrankenPHP Process

Created Caddyfile: /path/to/project/Caddyfile.runtime
Created PHP config: /path/to/project/frankenphp-php.ini
Starting FrankenPHP process...

INFO using config from file
INFO adapted config to JSON
INFO admin endpoint started
# æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨ï¼Œæ²¡æœ‰å¼ƒç”¨è­¦å‘Š
```

### åŠŸèƒ½ç‰¹æ€§
- ğŸ§¹ **æ¸…æ´çš„æ§åˆ¶å°è¾“å‡º**: ä¸å†æœ‰å¤§é‡å¼ƒç”¨è­¦å‘Š
- ğŸš€ **é«˜æ€§èƒ½ Worker æ¨¡å¼**: å¸¸é©»å†…å­˜ï¼Œå¿«é€Ÿå“åº”
- ğŸ›¡ï¸ **æ™ºèƒ½é”™è¯¯å¤„ç†**: æŠ‘åˆ¶æ— å®³è­¦å‘Šï¼Œä¿ç•™é‡è¦é”™è¯¯
- ğŸ“Š **ä¼˜åŒ–çš„ PHP é…ç½®**: é’ˆå¯¹ FrankenPHP ä¼˜åŒ–çš„è®¾ç½®
- ğŸ”„ **è‡ªåŠ¨æ–‡ä»¶ç®¡ç†**: ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨åˆ›å»ºå’Œæ¸…ç†

ç°åœ¨ FrankenPHP Runtime å¯ä»¥åœ¨æ²¡æœ‰çƒ¦äººçš„ session å¼ƒç”¨è­¦å‘Šçš„æƒ…å†µä¸‹æ­£å¸¸è¿è¡Œï¼Œæä¾›æ¸…æ´ã€é«˜æ€§èƒ½çš„ ThinkPHP åº”ç”¨æœåŠ¡ï¼
